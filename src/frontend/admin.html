<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLMS.txt Generator Admin</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        .admin-container {
            padding: 40px 0;
        }
        
        .admin-header {
            margin-bottom: 30px;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .admin-table th,
        .admin-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .admin-table th {
            background-color: var(--secondary-bg);
            font-weight: 600;
        }
        
        .admin-table tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .pagination button {
            padding: 8px 12px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button.active {
            background-color: var(--primary-color);
            color: #000;
            border-color: var(--primary-color);
        }
        
        .detail-view {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .detail-content {
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow: auto;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: var(--success-color);
            color: #000;
        }
        
        .badge-error {
            background-color: var(--error-color);
            color: #fff;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">LLMS.txt Generator Admin</div>
            <nav>
                <ul>
                    <li><a href="index.html">Back to Generator</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section class="admin-container">
            <div class="container">
                <div class="admin-header">
                    <h1>Generation Records</h1>
                    <p>View and manage LLMS.txt generation records</p>
                </div>
                
                <div class="admin-table-container">
                    <table class="admin-table" id="generationsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Company</th>
                                <th>Website</th>
                                <th>Type</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="6" style="text-align: center;">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="pagination" id="pagination"></div>
                </div>
                
                <div class="detail-view" id="detailView">
                    <div class="detail-header">
                        <h2>Generation Details</h2>
                        <button class="btn-secondary" id="closeDetailBtn">Close</button>
                    </div>
                    <div id="detailContent"></div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Variables
        let currentPage = 1;
        const limit = 10;
        let totalPages = 0;
        let generations = [];

        // DOM Elements
        const tableBody = document.getElementById('tableBody');
        const pagination = document.getElementById('pagination');
        const detailView = document.getElementById('detailView');
        const detailContent = document.getElementById('detailContent');
        const closeDetailBtn = document.getElementById('closeDetailBtn');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadGenerations(currentPage);
            
            closeDetailBtn.addEventListener('click', () => {
                detailView.style.display = 'none';
            });
        });

        // Functions
        async function loadGenerations(page) {
            try {
                const response = await fetch(`/api/admin/generations?page=${page}&limit=${limit}`);
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const result = await response.json();
                
                if (result.success) {
                    generations = result.data;
                    totalPages = result.pagination.totalPages;
                    currentPage = result.pagination.page;
                    
                    renderTable();
                    renderPagination();
                }
            } catch (error) {
                console.error('Error loading generations:', error);
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Error loading data: ${error.message}</td></tr>`;
            }
        }

        function renderTable() {
            if (generations.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No records found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            
            generations.forEach(gen => {
                const row = document.createElement('tr');
                
                // Format date
                const date = new Date(gen.created_at);
                const formattedDate = date.toLocaleString();
                
                // Type badge
                const typeLabel = gen.full_version ? 'Full' : 'Standard';
                
                row.innerHTML = `
                    <td>${gen.id.substring(0, 8)}...</td>
                    <td>${gen.company_name}</td>
                    <td>${gen.website_url}</td>
                    <td><span class="badge ${gen.full_version ? 'badge-success' : ''}">${typeLabel}</span></td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="btn-secondary view-btn" data-id="${gen.id}">View</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => viewGenerationDetails(btn.dataset.id));
            });
        }

        function renderPagination() {
            pagination.innerHTML = '';
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => loadGenerations(currentPage - 1));
            pagination.appendChild(prevBtn);
            
            // Page buttons
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.classList.toggle('active', i === currentPage);
                pageBtn.addEventListener('click', () => loadGenerations(i));
                pagination.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => loadGenerations(currentPage + 1));
            pagination.appendChild(nextBtn);
        }

        async function viewGenerationDetails(id) {
            try {
                const response = await fetch(`/api/admin/generations/${id}`);
                if (!response.ok) throw new Error('Failed to fetch details');
                
                const result = await response.json();
                
                if (result.success) {
                    const gen = result.data;
                    
                    // Format date
                    const date = new Date(gen.created_at);
                    const formattedDate = date.toLocaleString();
                    
                    let html = `
                        <h3>${gen.company_name}</h3>
                        <p><strong>Website:</strong> ${gen.website_url}</p>
                        <p><strong>Created:</strong> ${formattedDate}</p>
                        <p><strong>Type:</strong> ${gen.full_version ? 'Comprehensive' : 'Standard'}</p>
                        <p><strong>Email:</strong> ${gen.email || 'N/A'}</p>
                        ${gen.full_version ? `<p><strong>Email Sent:</strong> ${gen.email_sent ? 'Yes' : 'No'}</p>` : ''}
                        
                        <h4>Company Description</h4>
                        <div class="detail-content">${gen.company_description}</div>
                    `;
                    
                    if (gen.llms_content) {
                        html += `
                            <h4>Standard LLMS.txt Content</h4>
                            <div class="detail-content">${gen.llms_content}</div>
                        `;
                    }
                    
                    if (gen.llms_full_content) {
                        html += `
                            <h4>Comprehensive LLMS-full.txt Content</h4>
                            <div class="detail-content">${gen.llms_full_content}</div>
                        `;
                    }
                    
                    detailContent.innerHTML = html;
                    detailView.style.display = 'block';
                    detailView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } catch (error) {
                console.error('Error loading generation details:', error);
                alert(`Error loading details: ${error.message}`);
            }
        }
    </script>
</body>
</html>